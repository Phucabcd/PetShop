<!DOCTYPE html>
<html lang="en" th:fragment="home(view)" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
    <meta charset="UTF-8">
    <title>Cửa hàng Ninja Pet - Rất hân hạnh phục vụ quý khách</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/images/logo/logo-1.png" type="image/x-icon">
    <!--    BOOTSTRAP5-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!--    FONT-GOOGLE-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Grandstander:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
          rel="stylesheet">
    <!--    FONTAWESOME-->
    <script src="https://kit.fontawesome.com/246169b37f.js" crossorigin="anonymous"></script>
    <!--    ANIMATE.CSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css"/>
    <!--   notify-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.css"/>
    <!--    JQUERY-->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
    <style>
        body {
            background: url("/images/background/bg.webp");
            font-family: 'Grandstander', cursive;
            background-size: cover;
            background-attachment: fixed;
            scroll-behavior: smooth;
        }

        .color {
            color: #f04336;
        }

        .background-color {
            background-color: #f04336;
        }

        .container {
            max-width: 1600px;
        }

        #menu {
            transition: 0.5s;
        }

        .fade-in {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        }

        .fade-in.show {
            opacity: 1;
            transform: translateY(0);
        }

        .button-image {
            background-color: white;
            border: 2px solid black;
            background-image: url("/images/background/button-2.png");
            background-repeat: no-repeat;
            background-size: cover;
            cursor: pointer;
            transition: 0.5s all;
        }

        .button-image:hover {
            border: 2px solid black;
            transform: translate(-5px, -5px);
            box-shadow: 1px 1px 0px #000,
            2px 2px 0px #000,
            3px 3px 0px #000,
            4px 4px 0px #000,
            5px 5px 0px #000,
            6px 6px 0px #000;
        }

        .button-image-white {
            border: 2px solid black;
            text-shadow: 0 0 10px rgb(0, 0, 0);
            background-image: url("/images/background/button-white.png");
            background-repeat: no-repeat;
            background-size: cover;
            cursor: pointer;
            transition: 0.5s;
        }

        .button-image-white:hover {
            transform: translate(-5px, -5px);
            box-shadow: 1px 1px 0px #000,
            2px 2px 0px #000,
            3px 3px 0px #000,
            4px 4px 0px #000,
            5px 5px 0px #000,
            6px 6px 0px #000;
        }

        .card-image {
            transition: 0.5s;
        }

        .card-image:hover {
            transform: scale(1.05);
        }

        h1 {
            font-size: 1.9rem !important;
        }

        h2 {
            font-size: 1.7rem !important;
        }

        h3 {
            font-size: 1.5rem !important;
        }

        h4 {
            font-size: 1.3rem !important;
        }

        h5 {
            font-size: 1rem !important;
        }

        p {
            font-size: 0.9rem !important;
        }

        @media (max-width: 992px) {
            h1 {
                font-size: 1.7rem !important;
            }

            h2 {
                font-size: 1.5rem !important;
            }

            h3 {
                font-size: 1.2rem !important;
            }

            h4 {
                font-size: 1rem !important;
            }

            h5 {
                font-size: 0.8rem !important;
            }

            p {
                font-size: 0.7rem !important;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem !important;
            }

            h2 {
                font-size: 1.3rem !important;
            }

            h3 {
                font-size: 1rem !important;
            }

            h4 {
                font-size: 0.8rem !important;
            }

            h5 {
                font-size: 0.7rem !important;
            }

            p {
                font-size: 0.6rem !important;
            }
        }

        .add-to-cart {
            opacity: 0;
            transition: all 0.5s;
        }

        .add-to-cart-container:hover .add-to-cart {
            opacity: 1;
        }

        .add-to-cart:hover {
            background-color: #cc382e !important;
        }

        .sticky-element {
            /*position: -webkit-sticky;*/
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .order-history-hover {
            transition: 0.5s;
        }

        .order-history-hover:hover {
            border-left: 10px solid #f04336;
        }

        .hover-animation {
            background: rgba(71, 74, 255, 0);
            background: -webkit-linear-gradient(121deg, rgba(71, 74, 255, 0) 0%, #ff8383 50%, rgba(255, 255, 255, 0) 100%);
            background: linear-gradient(121deg, rgba(71, 74, 255, 0) 0%, #ff8383 50%, rgba(255, 255, 255, 0) 100%);
        }

        .link-wrapper {
            display: flex;
            position: absolute;
            left: 0;
            bottom: 45%;
            transform: translateY(50%);
            width: 200%;
            animation: marquee 20s linear infinite;
        }

        .link-wrapper:hover {
            animation-play-state: paused;
        }


        .link {
            display: inline-block;
            text-align: center;
            line-height: 50px;
            padding: 0 50px;
            margin: 0 10px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }

        .link-wrapper {
            position: absolute;
            width: 100%;
            white-space: nowrap;
            animation: marquee 15s linear infinite;
        }

        @keyframes marquee {
            0% {
                left: 100%;
            }
            100% {
                left: -100%;
            }
        }

        .star-rating {
            font-size: 2rem;
            color: #ddd; /* Default color for unselected stars */
            display: flex;
            gap: 0.2rem;
            cursor: pointer;
        }

        .star-rating .selected {
            color: #f4c150; /* Yellow for selected stars */
        }


    </style>
</head>
<body ng-app="myApp" ng-controller="myCtrl">
<header id="menu" class="sticky-top" th:insert="~{/layout/_menu}"></header>
<main class="container p-0 bg-white rounded-3 border border-2 border-dark animate__animated animate__fadeIn animate__faster"
      th:insert="${view}" ng-cloak></main>
<footer th:insert="~{/layout/_footer}"
        class="bg-white rounded-3 container overflow-hidden my-3 p-0 border border-2 border-dark"></footer>
<!--MODULE-->
<div th:insert=" ~{/module/_backToTop}"></div>
<div th:insert=" ~{/module/_loadingSpinner}"></div>
<div th:insert=" ~{/layout/_ReviewModal}"></div>
</body>
<!--    BOOTSTRAP5-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-notify@1.0.4/dist/simple-notify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<!--    JS-->
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
<script>
    const socket = new SockJS('http://172.16.72.83:8080/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        stompClient.subscribe('/', function (response) {
            Swal.fire({
                title: 'Thông báo mới',
                text: response.body,
                icon: 'info',
                confirmButtonText: 'OK',
                autoclose: true,
                autotimeout: 2000
            });
        });
    });
    var prevScrollpos = window.scrollY;
    let goToTop = document.getElementById('goToTop');

    window.onscroll = function () {
        // Điều khiển menu khi cuộn
        var currentScrollPos = window.scrollY;
        if (prevScrollpos > currentScrollPos) {
            document.getElementById("menu").style.top = "0";
        } else {
            document.getElementById("menu").style.top = "-100px";
        }
        prevScrollpos = currentScrollPos;

        // Điều khiển nút "Go to Top"
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            goToTop.style.display = 'block';
        } else {
            goToTop.style.display = 'none';
        }
    };

    // Hàm để cuộn lên đầu trang
    function goTop() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }

    // Swiper
    const swiper = new Swiper('.swiper-container', {
        slidesPerView: 2,
        spaceBetween: 20,
        // Phản hồi (responsive)
        breakpoints: {
            576: {
                slidesPerView: 3,
                spaceBetween: 30,
            },
            768: {
                slidesPerView: 4,
                spaceBetween: 40,
            },
            992: {
                slidesPerView: 5,
                spaceBetween: 50,
            },
            1200: {
                slidesPerView: 6,
                spaceBetween: 60,
            },
        },
        autoplay: {
            delay: 3000, // 3 giây
            disableOnInteraction: false,
        },
        loop: true,
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        }
    });
    const swiper_banner = new Swiper('.swiper-container-banner', {
        slidesPerView: 1,
        loop: true,
        autoplay: {
            delay: 3000, // 3 giây
            disableOnInteraction: false,
        },
        navigation: {
            nextEl: '.swiper-button-next-banner',
            prevEl: '.swiper-button-prev-banner',
        },
        pagination: {
            el: '.swiper-pagination-banner',
            clickable: true,
        },
        crossFade: true,
    });
    document.addEventListener("scroll", () => {
        const elements = document.querySelectorAll(".fade-in");
        const windowHeight = window.innerHeight;

        elements.forEach(element => {
            const elementTop = element.getBoundingClientRect().top;
            const elementBottom = element.getBoundingClientRect().bottom;

            // Kiểm tra nếu thẻ nằm trong vùng hiển thị
            if (elementTop < windowHeight - 100 && elementBottom > 100) {
                element.classList.add("show");
            } else {
                element.classList.remove("show");
            }
        });
    });
    $(document).ready(function () {
        $("#search-box").autocomplete({
            source: function (request, response) {
                const category = $("#searchCategory").val();
                const apiURL = category === "pet" ? 'http://localhost:8080/api/pet' : 'http://localhost:8080/api/product';

                fetch(apiURL)
                    .then(res => res.json())
                    .then(data => {
                        const results = $.map(data, item => {
                            const itemName = category === "pet" ? item.breed : item.productName;
                            if (itemName.toLowerCase().includes(request.term.toLowerCase())) {
                                const imageUrl = category === "pet"
                                    ? `/images/pet/${item.photo}`
                                    : `/images/product/${item.photo}`;

                                return {
                                    label: `
                                    <div class="autocomplete-item" style="display: flex; align-items: center;">
                                        <strong style="flex: 1;">${itemName}</strong>
                                        <p style="margin: 0; flex-shrink: 0;">Giá: ${item.price.toLocaleString()}đ</p>
                                        <img src="${imageUrl}" alt="${itemName}" style="width: 50px; height: 50px; margin-left: 10px; object-fit: cover;">
                                    </div>`,
                                    value: itemName,
                                    id: item.id
                                };
                            }
                        });
                        response(results);
                    })
                    .catch(error => console.error(`Error fetching ${category}:`, error));
            },
        })
            .data("ui-autocomplete")._renderItem = function (ul, item) {
            return $("<li>")
                .data("item.autocomplete", item)
                .append(item.label)
                .appendTo(ul);
        };
    });

</script>
<script>
    const app = angular.module('myApp', []);
    app.controller('myCtrl', function ($scope, $http) {
        // Giỏ hàng
        $scope.cart = {
            items: JSON.parse(localStorage.getItem('cart')) || [],

            add(id) {
                $http.get(`/api/product/${id}`).then(response => {
                    const product = response.data;
                    const productQuantity = product.quantity;

                    if (productQuantity === 0) {
                        new Notify({
                            title: `Sản phẩm ${product.productName} đã hết hàng`,
                            status: 'error',
                            autoclose: true,
                            autotimeout: 2000
                        });
                        return;
                    }
                    const item = this.items.find(item => item.id === id);

                    if (item) {
                        if (item.quantity < productQuantity) {
                            item.quantity++;
                        } else {
                            item.quantity = productQuantity
                            new Notify({
                                title: `Số lượng sản phẩm: ${item.productName} đã đạt giới hạn`,
                                status: 'warning',
                                autoclose: true,
                                autotimeout: 2000
                            });
                        }
                        this.saveToLocalStorage();

                    } else {
                        product.quantity = 1;
                        this.items.push(product);
                        this.saveToLocalStorage();
                        new Notify({
                            title: 'Sản phẩm đã được thêm vào giỏ hàng',
                            status: 'success',
                            autoclose: true,
                            autotimeout: 2000
                        });
                    }
                }).catch(error => {
                    console.error("Lỗi khi lấy sản phẩm:", error);
                    new Notify({
                        title: 'Lỗi khi thêm sản phẩm',
                        status: 'error',
                        autoclose: true,
                        autotimeout: 2000
                    });
                });
            },

            remove(id) {
                const index = this.items.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.items.splice(index, 1);
                    this.saveToLocalStorage();
                    this.loadFromLocalStorage();
                    new Notify({
                        title: 'Sản phẩm đã được xóa khỏi giỏ hàng',
                        status: 'success',
                        autoclose: true,
                        autotimeout: 2000
                    })
                }
            },

            removeAll() {
                Swal.fire({
                    title: 'Xóa tất cả',
                    text: 'Xóa tất cả sản phẩm trong giỏ?',
                    icon: 'info',
                    cancelButtonText: 'Hủy',
                    showConfirmButton: true,
                    showCancelButton: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem('cart');
                        window.location.href = "http://localhost:8080/cart-detail";
                    }
                })
            },

            updateQuantity(item) {
                $http.get(`/api/product/${item.id}`)
                    .then(response => {
                        const productQuantity = response.data.quantity;

                        if (item.quantity > productQuantity) {
                            alert("Số lượng yêu cầu vượt quá số lượng có sẵn!");
                            item.quantity = productQuantity;
                        } else if (item.quantity < 1) {
                            item.quantity = 1;
                        }

                        this.updateTotal();
                        this.saveToLocalStorage();
                    })
                    .catch(error => {
                        console.error("Lỗi khi lấy số lượng sản phẩm từ API:", error);
                    });
            },

            cartTotal() {
                return this.items.reduce((total, item) => total + (item.price * item.quantity), 0);
            },

            cartTotalAll() {
                return $scope.cart.total - ($scope.discountAmount || 0) + 50000;
            },

            updateTotal() {
                this.total = this.cartTotal();
                localStorage.setItem('cartTotal', this.total);
            },

            saveToLocalStorage() {
                localStorage.setItem('cart', JSON.stringify(this.items));
                this.updateTotal(); // Cập nhật tổng khi lưu
            },

            loadFromLocalStorage() {
                const storedItems = JSON.parse(localStorage.getItem('cart'));
                if (storedItems) {
                    this.items = storedItems;
                }
                this.updateTotal();
            },

            // Hàm để lấy detailItems từ items
            getDetailItems() {
                return this.items;
            },

            //
            getPayMent() {
                return this.getDetailItems()
            }
        };

        // Tải giỏ hàng từ localStorage khi khởi động ứng dụng
        $scope.cart.loadFromLocalStorage();


        // Voucher
        $scope.vouchers = []
        $scope.voucherCode = '';
        $scope.discountAmount = 0;
        $scope.successMessage = '';
        $scope.errorMessage = '';

        $http.get("/api/voucher").then(function (response) {
            const currentDate = new Date();
            $scope.vouchers = response.data.filter(voucher => {
                const expiryDate = new Date(voucher.expiryDate);
                return currentDate <= expiryDate
            });
        }).catch(function (error) {
            console.error("Error fetching vouchers", error);
        });

        $scope.applyVoucher = function (voucherCode) {
            if (!$scope.cart.items || $scope.cart.items.length === 0) {
                $scope.errorMessage = "Giỏ hàng trống. Không thể áp dụng voucher!";
                $scope.successMessage = '';
                $scope.discountAmount = '';
                localStorage.removeItem('voucherCode')
                localStorage.removeItem('discountAmount')
                return;
            }
            $http.get("/api/voucher/" + voucherCode)
                .then(function (response) {
                    if (response.data) {
                        $scope.successMessage = "Voucher đã được áp dụng thành công!";
                        $scope.discountAmount = response.data.discount;
                        $scope.errorMessage = '';

                        localStorage.setItem('voucherCode', voucherCode);
                        localStorage.setItem('discountAmount', response.data.discount);
                    } else {
                        $scope.errorMessage = "Voucher không hợp lệ!";
                        $scope.discountAmount = "";
                        $scope.successMessage = '';
                    }
                })
                .catch(function (error) {
                    $scope.errorMessage = "Có lỗi xảy ra khi áp dụng mã giảm giá!";
                    console.error("Lỗi áp dụng voucher", error);
                });
        };
        $scope.loadVoucherFromLocalStorage = function () {
            $scope.voucherCode = localStorage.getItem('voucherCode');
            $scope.discountAmount = parseFloat(localStorage.getItem('discountAmount')) || 0;
        };

        $scope.loadVoucherFromLocalStorage();


        //checkout
        $scope.checkout = function () {
            Swal.fire({
                title: 'Xác nhận thanh toán',
                icon: 'info',
                cancelButtonText: 'Hủy',
                showConfirmButton: true,
                showCancelButton: true
            }).then((result) => {
                if (result.isConfirmed) {
                    const username = document.getElementById("username_auth").textContent;
                    const cartTotal = JSON.parse(localStorage.getItem('cartTotal'));
                    const cartItems = JSON.parse(localStorage.getItem('cart'));
                    const userAddress = document.getElementById("userAddress").value;
                    const currentDate = new Date();

                    if (cartItems != null) {
                        Promise.all([
                            $http.get("/api/user/" + username),
                            $http.get("/api/orderStatus/1"),
                            $http.get("/api/paymentStatus/1")
                        ])
                            .then(function (responses) {
                                const userResponse = responses[0].data;
                                const orderStatusResponse = responses[1].data;
                                const paymentStatusResponse = responses[2].data;
                                const order = {
                                    totalAmount: cartTotal + 50000 - $scope.discountAmount,
                                    userName: {userName: userResponse.username,},
                                    shippingAddress: userAddress,
                                    enable: true,
                                    orderStatusID: {id: orderStatusResponse.id},
                                    paymentStatusID: {id: paymentStatusResponse.id},
                                    orderDate: currentDate
                                };
                                return $http.post("/api/order", order);
                            })
                            .then(function (response) {
                                const orderID = response.data.id; // Lấy OrderID từ phản hồi
                                const orderDetailPromises = cartItems.map((item) => {
                                    const orderDetail = {
                                        orderID: {id: orderID},
                                        productID: {id: item.id},
                                        quantity: item.quantity,
                                        price: item.price,
                                        reviewStatus: false
                                    };
                                    //update lai quantity khi checkout
                                    const updateQuantityPromise = $http.put(
                                        `/api/product/${item.id}/updateQuantity`,
                                        {quantity: item.quantity}
                                    );

                                    return Promise.all([
                                        $http.post("/api/order-detail", orderDetail),
                                        updateQuantityPromise
                                    ]);
                                });

                                return Promise.all(orderDetailPromises);

                            })
                            .then(function () {

                                console.log("Order và OrderDetail thành công");

                                localStorage.removeItem('cart');
                                localStorage.removeItem('voucherCode');
                                localStorage.removeItem('discountAmount');

                                Swal.fire({
                                    title: 'Thanh toán thành công',
                                    icon: 'success',
                                    timer: 2000,
                                    timerProgressBar: true,
                                    willClose: () => {
                                        window.location.href = "http://localhost:8080/cart-payMent";
                                    }
                                });
                            })
                            .catch(function (error) {
                                console.error("Lỗi khi order", error);
                                Swal.fire({
                                    title: 'Có lỗi xảy ra!',
                                    text: 'Không thể hoàn tất thanh toán. Vui lòng thử lại.',
                                    icon: 'error'
                                });
                            });
                    } else {
                        Swal.fire({
                            title: 'Chua co don hang',
                            icon: 'info',
                        })
                    }
                }
            });
        };
        // $scope.checkout = function () {
        //     const username = document.getElementById("username_auth").textContent;
        //     $http.get("/api/user/" + username).then(function (response) {
        //         $scope.usernameData = response.data;  // Sửa ở đây
        //     }).catch(function (error) {
        //         console.log("Lỗi lấy thông tin người dùng", error);
        //     });
        //
        //
        //     $http.get("/api/orderStatus/1").then(function (response) {
        //         $scope.orderStatusData = response.data;
        //     }).catch(function (error) {
        //         console.log("Lỗi lấy trạng thái đơn hàng", error);
        //     });
        //
        //
        //     $http.get("/api/paymentStatus/1").then(function (response) {
        //         $scope.paymentStatusData = response.data;
        //     }).catch(function (error) {
        //         console.log("Lỗi lấy trạng thái thanh toán", error);
        //     });
        //
        //     const cartTotal = JSON.parse(localStorage.getItem('cartTotal'));
        //     const userAddress = document.getElementById("userAddress").value;
        //     const currentDate = new Date();
        //
        //     console.log(cartTotal);
        //     console.log(userAddress);
        //     console.log(currentDate);
        //     console.log($scope.usernameData.username);
        //     console.log($scope.orderStatusData);
        //     console.log($scope.paymentStatusData);
        //
        //     const order = {
        //         totalAmount: cartTotal,
        //         userName: {
        //             userName: $scope.usernameData.username,
        //         },
        //         shippingAddress: userAddress,
        //         enable: true,
        //         orderStatusID: {
        //           id : $scope.orderStatusData.id
        //         },
        //         paymentStatusID: {
        //             id :  $scope.paymentStatusData.id
        //         },
        //         orderDate: currentDate
        //     };
        //
        //
        //     $http.post("/api/order", order).then(function (response) {
        //         console.log("Order thành công");
        //     }).catch(function (error) {
        //         console.log("Lỗi khi order", error);
        //     });
        // }
        //history
        $scope.getOrderHistory = function () {
            $http.get("/api/order/history")
                .then(function (response) {
                    $scope.orderHistory = response.data;
                })
                .catch(function (error) {
                    console.error("Lỗi khi lấy lịch sử đơn hàng", error);
                });
        };

        $scope.updatePaymentStatus = function (history) {
            if (history.orderStatusID.statusName === 'Đã giao') {
                history.paymentStatusID = {id: 2};
            } else if (history.paymentStatusID.id === 2) {
                history.paymentStatusID = {id: 2};
            } else {
                history.paymentStatusID = {id: 1};
            }
        };

        $scope.getOrderHistory();

        /*HISTORY ORDER DETAIL*/
        $scope.getHistoryOrderDetail = function (orderId) {
            $http.get("/api/order-detail/" + orderId)
                .then(function (response) {
                    $scope.historyOrderDetail = response.data;
                })
                .catch(function (error) {
                    console.error("Lỗi khi lấy chi tiết đơn hàng", error);
                });
        };
        //huy don hang
        $scope.deleteHistory = function (id) {
            Swal.fire({
                title: 'Bạn có chắc chắn muốn hủy đơn hàng này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xác nhận',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $http.put("/api/order/status/" + id)

                        .then(function (response) {
                            Swal.fire({
                                title: 'Hủy đơn hàng thành công',
                                icon: 'success',
                                timer: 2000,
                                timerProgressBar: true
                            });
                            $scope.getOrderHistory();
                        })
                        .catch(function (error) {
                            Swal.fire({
                                title: 'Hủy đơn hàng thất bại',
                                icon: 'error',
                                timer: 2000,
                                timerProgressBar: true
                            });
                        });
                }
            });
        };

        $scope.review = function (productId, orderID) {
            const username = document.getElementById("username_auth").textContent;
            Promise.all([
                $http.get("/api/user/" + username),
                $http.get("/api/product/" + productId),
                $http.get("/api/order/" + orderID)
            ])
                .then(function (response) {
                    $scope.reviewData.username = response[0].data;
                    $scope.reviewData.productID = response[1].data;
                    $scope.reviewData.orderID = response[2].data;
                })
                .catch(function (error) {
                    console.error("Loi khong lay duoc product user", error);
                });
            const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'), {
                keyboard: true
            });
            reviewModal.show();
        };

        $scope.submitReview = function () {
            const date = new Date()
            const review = {
                comment: $scope.reviewData.comment,
                userName: $scope.reviewData.username,
                productID: $scope.reviewData.productID,
                rating: $scope.reviewData.rating,
                reviewDate: date
            };

            $http.post("/api/review", review)
                .then(function (response) {
                    Swal.fire({
                        title: 'Review thành công',
                        icon: 'success',
                        timer: 2000,
                        timerProgressBar: true,
                        willClose: () => {
                            window.location.reload();
                        }
                    });
                })
                .catch(function (error) {
                    console.error("Loi review", error);
                });
            $http.put("/api/order-detail/" + $scope.reviewData.orderID.id + '/' + $scope.reviewData.productID.id)
                .then(function (response) {

                }).catch(function (error) {
                console.log("loi" + error)
            })


        };

        $scope.reviewData = {
            rating: 0,
            comment: ''
        };

        $scope.setRating = function (star) {
            $scope.reviewData.rating = star;
        };

        $scope.closeReview = function () {
            $scope.reviewData.rating = 0;
            $scope.reviewData.comment = '';
        };
    });
</script>
<script>
    function subscribe() {
        // Lấy giá trị từ các trường input
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const phoneNumber = document.getElementById('phoneNumber').value.trim();

        // Kiểm tra nếu trường nào để trống
        if (!name || !email || !phoneNumber) {
            Swal.fire({
                title: 'Thông Báo',
                text: 'Tất cả các trường đều bắt buộc!',
                icon: 'warning'
            });
            return;
        }

        // Validate email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            Swal.fire({
                title: 'Thông Báo',
                text: 'Định dạng Email không hợp lệ!',
                icon: 'warning'
            });
            return;
        }

        // Validate số điện thoại
        const phoneRegex = /^0\d{9}$/;
        if (!phoneRegex.test(phoneNumber)) {
            Swal.fire({
                title: 'Thông Báo',
                text: 'Số điện thoại phải bắt đầu bằng số 0 và có đúng 10 chữ số!',
                icon: 'warning'
            });
            return;
        }

        // Hiển thị thông báo "Đang xử lý..."
        Swal.fire({
            title: 'Đang xử lý...',
            text: 'Vui lòng chờ...',
            icon: 'info',
            showConfirmButton: false,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Tạo dữ liệu gửi đi
        const formData = {
            name: name,
            email: email,
            phoneNumber: phoneNumber
        };

        // Gửi yêu cầu đến server
        fetch('http://localhost:8080/api/subscriptions/subscribe', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok) {
                    Swal.fire({
                        title: 'Đăng Ký Thành Công',
                        text: 'Bạn đã đăng ký thành công!! Vui lòng kiểm tra Email',
                        icon: 'success'
                    }).then(() => {
                        // Reset form sau khi thành công
                        document.getElementById('subscribeForm').reset();
                    });
                } else {
                    Swal.fire({
                        title: 'Thông Báo Lỗi',
                        text: 'Email đã được đăng ký!',
                        icon: 'error'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: 'Lỗi hệ thống',
                    icon: 'error'
                });
                console.error('Error:', error);
            });
    }
</script>
</html>